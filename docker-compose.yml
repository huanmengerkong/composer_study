version: '2.2'
services:
    nginx:
        container_name: nginx
        image: nginx
        expose:
            - "80"
        ports:
            - "8099:80"
        volumes:
            - ./app:/var/www/html
            - ./app/config/nginx/conf.d:/etc/nginx/conf.d:rw
            - ./app/log:/var/log/nginx
        #working_dir: /app
        links:
           - fpm74:fpm74
        command: [nginx-debug, '-g', 'daemon off;']
    fpm74:
        container_name: fpm74
        build: ./fpm73-ext-docker
        ports:
            - "9000:9000"
        volumes:
            - ./app:/var/www/html
              #working_dir:  /var/www/html
        depends_on:
           - mysql
           - redis
        links:
           - mysql:mysql
           - redis:redis
           - mongo:mongo  
    mysql:
       container_name: db
       image: mysql:latest
       command: --default-authentication-plugin=mysql_native_password
       restart: always
       expose:
           - "3306"
       ports:
           - "3306:3306"
       volumes:
           - ./app/mysql:/var/lib/mysql
       environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_USER: root
          MYSQL_PASSWORD: root
    redis:
       container_name: redis
       image: redis
       restart: always
       expose:
           - "6379"
       ports:
           - "6379:6379"
       volumes:
           - ./app/redis:/data
       command: redis-server --appendonly yes
       logging:
           driver: json-file
           options:
               max-size: "200k" # 单个文件大小为200k
               max-file: "10" # 最多10个文件
    mongo:
       image: mongo
       container_name: mongo_db
       restart: always
       expose:
          - 27017
       ports:
          - "27017:27017"     
       environment:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: root
    mongo-express:
       image: mongo-express
       restart: always
       ports:
          - 8081:8081
       environment:
          ME_CONFIG_MONGODB_ADMINUSERNAME: root
          ME_CONFIG_MONGODB_ADMINPASSWORD: root           
          ME_CONFIG_BASICAUTH_USERNAME: root
          ME_CONFIG_BASICAUTH_PASSWORD: root
       links:
          - mongo:mongo        
    composer:
       image: composer
       container_name: composer
       command: ["composer", "install" ] #update
       volumes:
          - ./app:/app      
